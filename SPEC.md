構築するシステムの要件まとめ

1. 目的・コンセプト

    Cosenseに貼り付ける画像専用のアップローダー。

    著作権的にデリケートな画像を扱う可能性があるため、Gyazoなどの外部サービスを避け、セルフホストする。

    ファイル一覧機能（ファイラー）は持たず、シンプルなアップロード機能に特化する。

2. システム環境

    OS: Ubuntu Server

    サーバー: Node.js + TypeScript で自作する。

    使用ポート: 8080や3000など、Web開発で一般的に使われるポートは避ける（例: 5050など）。

    ネットワーク: サーバー側のポート開放は行わず、Cloudflare Tunnel を使用して公開する。

    ドメイン: Cloudflareで管理しているドメインのサブドメイン（例: files.example.com）を使用する。

    ストレージ: ローカルディスクに適切なディレクトリを作成して保存する。

3. Web UI (アップロード画面) の機能

    アップロード方法:

        ファイル選択（OS規定のファイラーが起動）

        クリップボードからの貼り付け（ショートカットキー対応）

        ドラッグアンドドロップ

    対応ファイル形式: 画像ファイル（拡張子の制限なし）

    ファイルサイズ制限: なし

    プレビュー: ファイル選択時または貼り付け時に、アップロードする画像のプレビューを表示する。

    リンク生成: アップロード完了後、UUIDなど推測困難なファイル名を持つリンクを生成する。アップロードしたファイルは名前が被らないよう、ファイル名をUUIDにする。

    リンク履歴: 生成されたリンクを画面上のリストに表示する。各リンクにはコピーボタンを配置し、リストの行をクリックしてもコピーできるようにする。クリック時は行の色を変更して選択状態を視覚的に示す。この履歴はブラウザ側（localStorageなど）で管理し、キャッシュクリアで消えて良い。

    レイアウト: 中央に大きいドラッグアンドドロップエリアとファイル選択ボタンを配置

    セキュリティ: アップロード画面へのパスワード認証などのアクセス制限は不要とする。

4. GC (ガベージコレクション) 機能

    目的: CosenseのバックアップJSONに記載されていない＝（Cosense上から削除された）ファイルを、サーバー上から物理的に削除する。

    実行方法: アップロード画面と同じWeb UIに、CosenseからエクスポートしたバックアップJSONファイルを手動でアップロードする。

    トリガー: JSONファイルがアップロードされたことをトリガーに、サーバー側でGC処理を実行する。

    JSON構造: pages -> lines -> text にファイル名の文字列が含まれているファイルは必要とみなし、すべて探索して見つからないファイルは不要として削除する。

    実行タイミング: ユーザーがCosenseのバックアップファイルを画像アップロードの場所にアップロードしたタイミングで実行する。